{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://physics91.com/agents-context-preserver/schemas/config.schema.json",
  "title": "PluginConfig",
  "description": "Configuration schema for AGENTS Context Preserver plugin",
  "type": "object",
  "required": [
    "enabled",
    "storage_path",
    "agents_md_paths",
    "capture",
    "injection",
    "hooks",
    "security",
    "logging",
    "backup"
  ],
  "properties": {
    "enabled": {
      "type": "boolean",
      "description": "Whether the plugin is enabled",
      "default": true
    },
    "storage_path": {
      "type": "string",
      "description": "Path where context state files are stored",
      "minLength": 1,
      "maxLength": 500,
      "default": "./.agents-context",
      "examples": ["./.agents-context", "~/.local/share/agents-context"]
    },
    "agents_md_paths": {
      "type": "object",
      "description": "Configuration for AGENTS.md file locations",
      "required": ["global", "project", "include_local", "local_max_depth"],
      "properties": {
        "global": {
          "type": "string",
          "description": "Path to global AGENTS.md file",
          "maxLength": 500,
          "default": "~/.config/agents/AGENTS.md",
          "examples": ["~/.config/agents/AGENTS.md", "~/.agents/AGENTS.md"]
        },
        "project": {
          "type": "string",
          "description": "Path to project-level AGENTS.md file (relative to project root)",
          "maxLength": 500,
          "default": "./AGENTS.md",
          "examples": ["./AGENTS.md", "./.agents/AGENTS.md"]
        },
        "include_local": {
          "type": "boolean",
          "description": "Whether to include local directory AGENTS.md files",
          "default": true
        },
        "local_max_depth": {
          "type": "integer",
          "description": "Maximum directory depth to search for local AGENTS.md files",
          "minimum": 0,
          "maximum": 10,
          "default": 3,
          "examples": [3, 5]
        }
      },
      "additionalProperties": false
    },
    "capture": {
      "type": "object",
      "description": "Settings for capturing context information",
      "required": [
        "max_history_items",
        "max_tool_history",
        "max_output_length",
        "capture_tool_output"
      ],
      "properties": {
        "max_history_items": {
          "type": "integer",
          "description": "Maximum number of history items to keep",
          "minimum": 1,
          "maximum": 100,
          "default": 20
        },
        "max_tool_history": {
          "type": "integer",
          "description": "Maximum number of tool history entries to keep",
          "minimum": 1,
          "maximum": 50,
          "default": 10
        },
        "max_output_length": {
          "type": "integer",
          "description": "Maximum character length for output summaries",
          "minimum": 50,
          "maximum": 5000,
          "default": 300
        },
        "capture_tool_output": {
          "type": "boolean",
          "description": "Whether to capture and store tool outputs",
          "default": true
        }
      },
      "additionalProperties": false
    },
    "injection": {
      "type": "object",
      "description": "Settings for context injection into prompts",
      "required": [
        "enabled",
        "max_tokens",
        "format",
        "include_agents_summary",
        "include_task_state",
        "include_file_context"
      ],
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether context injection is enabled",
          "default": true
        },
        "max_tokens": {
          "type": "integer",
          "description": "Maximum tokens to use for injected context",
          "minimum": 100,
          "maximum": 50000,
          "default": 4000
        },
        "format": {
          "type": "string",
          "description": "Format for injected context",
          "enum": ["markdown", "json"],
          "default": "markdown"
        },
        "include_agents_summary": {
          "type": "boolean",
          "description": "Include summary of AGENTS.md content",
          "default": true
        },
        "include_task_state": {
          "type": "boolean",
          "description": "Include current task state and progress",
          "default": true
        },
        "include_file_context": {
          "type": "boolean",
          "description": "Include information about active and modified files",
          "default": true
        }
      },
      "additionalProperties": false
    },
    "hooks": {
      "type": "object",
      "description": "Configuration for plugin hooks",
      "required": ["pre_compact", "session_start", "post_tool_use", "stop"],
      "properties": {
        "pre_compact": {
          "$ref": "#/definitions/HookConfig",
          "description": "Hook called before context compaction"
        },
        "session_start": {
          "$ref": "#/definitions/HookConfig",
          "description": "Hook called when a new session starts"
        },
        "post_tool_use": {
          "allOf": [
            { "$ref": "#/definitions/HookConfig" },
            {
              "type": "object",
              "properties": {
                "tracked_tools": {
                  "type": "array",
                  "description": "List of tool names to track (empty means all tools)",
                  "items": {
                    "type": "string",
                    "maxLength": 100
                  },
                  "maxItems": 50,
                  "default": [],
                  "examples": [["Read", "Write", "Bash", "Edit"]]
                }
              }
            }
          ],
          "description": "Hook called after a tool is used"
        },
        "stop": {
          "$ref": "#/definitions/HookConfig",
          "description": "Hook called when the session stops"
        }
      },
      "additionalProperties": false
    },
    "security": {
      "type": "object",
      "description": "Security settings for context preservation",
      "required": ["filter_secrets", "secret_patterns", "exclude_patterns"],
      "properties": {
        "filter_secrets": {
          "type": "boolean",
          "description": "Whether to filter out potential secrets from captured context",
          "default": true
        },
        "secret_patterns": {
          "type": "array",
          "description": "Regex patterns for detecting secrets to filter",
          "items": {
            "type": "string",
            "maxLength": 500
          },
          "maxItems": 100,
          "default": [
            "(?i)(api[_-]?key|apikey)\\s*[=:]\\s*['\"]?[a-zA-Z0-9_-]{20,}",
            "(?i)(secret|password|passwd|pwd)\\s*[=:]\\s*['\"]?[^\\s'\"]{8,}",
            "(?i)(token|bearer)\\s*[=:]\\s*['\"]?[a-zA-Z0-9_.-]{20,}",
            "(?i)(aws|gcp|azure)[_-]?(access|secret)?[_-]?(key|id)\\s*[=:]",
            "-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----"
          ],
          "examples": [["(?i)api[_-]?key\\s*[=:]\\s*['\"]?[a-zA-Z0-9]{20,}"]]
        },
        "exclude_patterns": {
          "type": "array",
          "description": "Glob patterns for files to exclude from context capture",
          "items": {
            "type": "string",
            "maxLength": 200
          },
          "maxItems": 100,
          "default": [
            "**/.env*",
            "**/*.pem",
            "**/*.key",
            "**/credentials*",
            "**/secrets*"
          ],
          "examples": [["**/.env*", "**/*.pem", "**/node_modules/**"]]
        }
      },
      "additionalProperties": false
    },
    "logging": {
      "type": "object",
      "description": "Logging configuration",
      "required": ["enabled", "level", "file"],
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether logging is enabled",
          "default": true
        },
        "level": {
          "type": "string",
          "description": "Minimum log level to record",
          "enum": ["debug", "info", "warn", "error"],
          "default": "info"
        },
        "file": {
          "type": "string",
          "description": "Path to log file",
          "maxLength": 500,
          "default": "./.agents-context/plugin.log",
          "examples": ["./.agents-context/plugin.log", "/var/log/agents-context.log"]
        }
      },
      "additionalProperties": false
    },
    "backup": {
      "type": "object",
      "description": "Backup settings for context state",
      "required": ["enabled", "max_backups"],
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether automatic backups are enabled",
          "default": true
        },
        "max_backups": {
          "type": "integer",
          "description": "Maximum number of backup files to keep",
          "minimum": 0,
          "maximum": 100,
          "default": 5
        }
      },
      "additionalProperties": false
    }
  },
  "definitions": {
    "HookConfig": {
      "type": "object",
      "description": "Configuration for a plugin hook",
      "required": ["enabled", "timeout_ms"],
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether the hook is enabled",
          "default": true
        },
        "timeout_ms": {
          "type": "integer",
          "description": "Timeout in milliseconds for hook execution",
          "minimum": 100,
          "maximum": 60000,
          "default": 5000
        }
      },
      "additionalProperties": true
    }
  },
  "additionalProperties": false
}
